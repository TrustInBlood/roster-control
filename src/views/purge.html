<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Member Purge - Roster Control</title>
  <style>
    * {
      box-sizing: border-box;
      margin: 0;
      padding: 0;
    }

    body {
      font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
      background: #1a1a2e;
      color: #eee;
      min-height: 100vh;
      padding: 20px;
    }

    .container {
      max-width: 1200px;
      margin: 0 auto;
    }

    h1 {
      color: #ff4444;
      margin-bottom: 10px;
    }

    .warning-banner {
      background: linear-gradient(135deg, #ff4444 0%, #cc0000 100%);
      padding: 20px;
      border-radius: 8px;
      margin-bottom: 20px;
      border-left: 5px solid #880000;
    }

    .warning-banner h2 {
      display: flex;
      align-items: center;
      gap: 10px;
      margin-bottom: 10px;
    }

    .warning-banner p {
      opacity: 0.9;
      line-height: 1.5;
    }

    .stats-grid {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
      gap: 15px;
      margin-bottom: 20px;
    }

    .stat-card {
      background: #252540;
      padding: 20px;
      border-radius: 8px;
      text-align: center;
    }

    .stat-card .number {
      font-size: 2.5em;
      font-weight: bold;
      color: #ff6b6b;
    }

    .stat-card .label {
      color: #888;
      margin-top: 5px;
    }

    .stat-card.warning .number {
      color: #ffa500;
    }

    .stat-card.danger .number {
      color: #ff4444;
    }

    .section {
      background: #252540;
      border-radius: 8px;
      padding: 20px;
      margin-bottom: 20px;
    }

    .section h3 {
      margin-bottom: 15px;
      color: #aaa;
      font-size: 0.9em;
      text-transform: uppercase;
      letter-spacing: 1px;
    }

    .table-wrapper {
      overflow-x: auto;
    }

    table {
      width: 100%;
      border-collapse: collapse;
    }

    th, td {
      padding: 12px;
      text-align: left;
      border-bottom: 1px solid #333;
    }

    th {
      background: #1a1a2e;
      color: #888;
      font-weight: 500;
      font-size: 0.85em;
      text-transform: uppercase;
      letter-spacing: 0.5px;
    }

    tr:hover {
      background: #2a2a4a;
    }

    .user-info {
      display: flex;
      align-items: center;
      gap: 10px;
    }

    .user-info img {
      width: 32px;
      height: 32px;
      border-radius: 50%;
    }

    .role-tag {
      display: inline-block;
      padding: 2px 8px;
      border-radius: 4px;
      font-size: 0.8em;
      margin: 2px;
    }

    .role-remove {
      background: #ff444433;
      color: #ff6b6b;
      border: 1px solid #ff444466;
    }

    .role-keep {
      background: #44ff4433;
      color: #6bff6b;
      border: 1px solid #44ff4466;
    }

    .has-staff {
      color: #ffa500;
    }

    .has-admin {
      color: #ff4444;
    }

    .more-indicator {
      text-align: center;
      padding: 15px;
      color: #888;
      font-style: italic;
    }

    .confirm-section {
      background: #1a1a1a;
      border: 2px solid #ff4444;
      border-radius: 8px;
      padding: 25px;
      margin-top: 30px;
    }

    .confirm-section h3 {
      color: #ff4444;
      margin-bottom: 15px;
    }

    .confirm-section p {
      margin-bottom: 15px;
      color: #aaa;
    }

    .confirm-input {
      display: flex;
      gap: 10px;
      margin-bottom: 15px;
    }

    .confirm-input input {
      flex: 1;
      padding: 12px 15px;
      border: 2px solid #333;
      border-radius: 6px;
      background: #252540;
      color: #eee;
      font-size: 1em;
    }

    .confirm-input input:focus {
      outline: none;
      border-color: #ff4444;
    }

    .btn {
      padding: 12px 25px;
      border: none;
      border-radius: 6px;
      font-size: 1em;
      cursor: pointer;
      transition: all 0.2s;
    }

    .btn-danger {
      background: #ff4444;
      color: white;
    }

    .btn-danger:hover:not(:disabled) {
      background: #ff6666;
    }

    .btn-danger:disabled {
      background: #553333;
      color: #888;
      cursor: not-allowed;
    }

    .progress-section {
      display: none;
      background: #252540;
      border-radius: 8px;
      padding: 20px;
      margin-top: 20px;
    }

    .progress-section.active {
      display: block;
    }

    .progress-bar {
      height: 10px;
      background: #1a1a2e;
      border-radius: 5px;
      overflow: hidden;
      margin: 15px 0;
    }

    .progress-bar-fill {
      height: 100%;
      background: linear-gradient(90deg, #ff4444, #ff6b6b);
      transition: width 0.3s;
    }

    .progress-text {
      text-align: center;
      color: #888;
    }

    .results-section {
      display: none;
      margin-top: 20px;
    }

    .results-section.active {
      display: block;
    }

    .result-stat {
      display: inline-block;
      margin-right: 20px;
      padding: 10px 15px;
      background: #1a1a2e;
      border-radius: 6px;
    }

    .result-stat.success {
      border-left: 3px solid #44ff44;
    }

    .result-stat.error {
      border-left: 3px solid #ff4444;
    }

    .loading {
      text-align: center;
      padding: 50px;
      color: #888;
    }

    .loading-spinner {
      width: 50px;
      height: 50px;
      border: 3px solid #333;
      border-top-color: #ff4444;
      border-radius: 50%;
      animation: spin 1s linear infinite;
      margin: 0 auto 20px;
    }

    @keyframes spin {
      to { transform: rotate(360deg); }
    }

    .error-message {
      background: #ff444433;
      border: 1px solid #ff4444;
      border-radius: 6px;
      padding: 15px;
      color: #ff6b6b;
    }
  </style>
</head>
<body>
  <div class="container">
    <h1>Member Purge</h1>
    <p style="color: #888; margin-bottom: 20px;">One-time operation to remove roles from unlinked members</p>

    <div class="warning-banner">
      <h2>WARNING: Destructive Operation</h2>
      <p>
        This will remove the <strong>MEMBER role</strong> and all <strong>staff/admin roles</strong> from users
        who have not linked their Steam account. <strong>Server nicknames will also be reset.</strong>
        Affected users will receive a DM notification with instructions to restore their roles using <code>/linkid</code>.
        Roles will be archived for 30 days.
      </p>
    </div>

    <div id="loading" class="loading">
      <div class="loading-spinner"></div>
      <p>Loading preview data...</p>
    </div>

    <div id="content" style="display: none;">
      <div class="stats-grid">
        <div class="stat-card danger">
          <div class="number" id="stat-total">0</div>
          <div class="label">Total Affected</div>
        </div>
        <div class="stat-card">
          <div class="number" id="stat-members">0</div>
          <div class="label">Members Only</div>
        </div>
        <div class="stat-card warning">
          <div class="number" id="stat-staff">0</div>
          <div class="label">With Staff Roles</div>
        </div>
        <div class="stat-card danger">
          <div class="number" id="stat-admin">0</div>
          <div class="label">With Admin Roles</div>
        </div>
        <div class="stat-card">
          <div class="number" id="stat-nicknames">0</div>
          <div class="label">Nicknames to Reset</div>
        </div>
      </div>

      <div class="section">
        <h3>Affected Users (Preview)</h3>
        <div class="table-wrapper">
          <table>
            <thead>
              <tr>
                <th>User</th>
                <th>Nickname</th>
                <th>Joined</th>
                <th>Roles to Remove</th>
                <th>Status</th>
              </tr>
            </thead>
            <tbody id="users-table">
            </tbody>
          </table>
        </div>
        <div id="more-indicator" class="more-indicator" style="display: none;"></div>
      </div>

      <div class="section">
        <h3>Role Removal Summary</h3>
        <div id="role-summary"></div>
      </div>

      <div class="confirm-section">
        <h3>Confirm Purge Execution</h3>
        <p>Type <strong>CONFIRM PURGE</strong> below to enable the execute button.</p>
        <div class="confirm-input">
          <input type="text" id="confirm-input" placeholder="Type CONFIRM PURGE" autocomplete="off">
          <button class="btn btn-danger" id="execute-btn" disabled>Execute Purge</button>
        </div>
        <p style="font-size: 0.85em; color: #666;">
          This action cannot be undone. Users must link their Steam account within 30 days to restore roles.
        </p>
      </div>

      <div class="progress-section" id="progress-section">
        <h3 style="color: #ff4444;">Purge In Progress...</h3>
        <div class="progress-bar">
          <div class="progress-bar-fill" id="progress-fill" style="width: 0%"></div>
        </div>
        <p class="progress-text" id="progress-text">Processing...</p>
      </div>

      <div class="results-section" id="results-section">
        <h3 style="color: #44ff44; margin-bottom: 15px;">Purge Complete</h3>
        <div id="results-stats"></div>
        <div id="results-errors" style="margin-top: 15px;"></div>
      </div>
    </div>

    <div id="error-container" style="display: none;">
      <div class="error-message" id="error-message"></div>
    </div>
  </div>

  <script>
    const token = new URLSearchParams(window.location.search).get('token');

    if (!token) {
      document.getElementById('loading').style.display = 'none';
      document.getElementById('error-container').style.display = 'block';
      document.getElementById('error-message').textContent = 'Missing authentication token. Access denied.';
    } else {
      loadPreview();
    }

    async function loadPreview() {
      try {
        const response = await fetch(`/purge/preview?token=${token}`);
        const data = await response.json();

        if (!response.ok) {
          throw new Error(data.error || 'Failed to load preview');
        }

        document.getElementById('loading').style.display = 'none';
        document.getElementById('content').style.display = 'block';

        // Update stats
        document.getElementById('stat-total').textContent = data.totalAffected;
        document.getElementById('stat-members').textContent = data.stats.membersOnly;
        document.getElementById('stat-staff').textContent = data.stats.withStaffRoles;
        document.getElementById('stat-admin').textContent = data.stats.withAdminRoles;
        document.getElementById('stat-nicknames').textContent = data.stats.withNicknames || 0;

        // Populate users table
        const tbody = document.getElementById('users-table');
        data.affectedUsers.forEach(user => {
          const tr = document.createElement('tr');

          // User info
          const userTd = document.createElement('td');
          userTd.innerHTML = `
            <div class="user-info">
              <img src="${user.avatarURL}" alt="">
              <div>
                <strong>${escapeHtml(user.username)}</strong>
              </div>
            </div>
          `;
          tr.appendChild(userTd);

          // Nickname column
          const nicknameTd = document.createElement('td');
          if (user.nickname) {
            nicknameTd.innerHTML = `<span style="color: #ffa500;">${escapeHtml(user.nickname)}</span>`;
          } else {
            nicknameTd.innerHTML = '<span style="color: #555;">-</span>';
          }
          tr.appendChild(nicknameTd);

          // Joined date
          const joinedTd = document.createElement('td');
          if (user.joinedAt) {
            const date = new Date(user.joinedAt);
            joinedTd.textContent = date.toLocaleDateString();
          } else {
            joinedTd.textContent = 'Unknown';
          }
          tr.appendChild(joinedTd);

          // Roles to remove
          const rolesTd = document.createElement('td');
          user.rolesToRemove.forEach(role => {
            const tag = document.createElement('span');
            tag.className = 'role-tag role-remove';
            tag.textContent = role.name;
            rolesTd.appendChild(tag);
          });
          tr.appendChild(rolesTd);

          // Status
          const statusTd = document.createElement('td');
          if (user.hasAdminRoles) {
            statusTd.innerHTML = '<span class="has-admin">Admin</span>';
          } else if (user.hasStaffRoles) {
            statusTd.innerHTML = '<span class="has-staff">Staff</span>';
          } else {
            statusTd.textContent = 'Member';
          }
          tr.appendChild(statusTd);

          tbody.appendChild(tr);
        });

        // More indicator
        if (data.moreAffected > 0) {
          const moreDiv = document.getElementById('more-indicator');
          moreDiv.textContent = `...and ${data.moreAffected} more affected users not shown`;
          moreDiv.style.display = 'block';
        }

        // Role summary
        const summaryDiv = document.getElementById('role-summary');
        const roleCounts = data.stats.roleRemovalCounts || {};
        Object.entries(roleCounts).forEach(([name, count]) => {
          const tag = document.createElement('span');
          tag.className = 'role-tag role-remove';
          tag.style.marginRight = '10px';
          tag.textContent = `${name}: ${count}`;
          summaryDiv.appendChild(tag);
        });

      } catch (error) {
        document.getElementById('loading').style.display = 'none';
        document.getElementById('error-container').style.display = 'block';
        document.getElementById('error-message').textContent = error.message;
      }
    }

    // Confirm input handling
    const confirmInput = document.getElementById('confirm-input');
    const executeBtn = document.getElementById('execute-btn');

    confirmInput.addEventListener('input', () => {
      executeBtn.disabled = confirmInput.value !== 'CONFIRM PURGE';
    });

    executeBtn.addEventListener('click', async () => {
      if (confirmInput.value !== 'CONFIRM PURGE') return;

      // Disable inputs
      confirmInput.disabled = true;
      executeBtn.disabled = true;
      executeBtn.textContent = 'Executing...';

      // Show progress
      document.querySelector('.confirm-section').style.display = 'none';
      document.getElementById('progress-section').classList.add('active');

      try {
        const response = await fetch(`/purge/execute?token=${token}`, {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' }
        });

        const data = await response.json();

        // Hide progress, show results
        document.getElementById('progress-section').classList.remove('active');
        document.getElementById('results-section').classList.add('active');

        const resultsStats = document.getElementById('results-stats');
        resultsStats.innerHTML = `
          <span class="result-stat success">Successful: ${data.results.successful}</span>
          <span class="result-stat error">Failed: ${data.results.failed}</span>
          <span class="result-stat">Nicknames Reset: ${data.results.nicknamesReset || 0}</span>
          <span class="result-stat">DMs Sent: ${data.results.dmsSent}</span>
          <span class="result-stat">DMs Failed: ${data.results.dmsFailed}</span>
        `;

        if (data.results.errors && data.results.errors.length > 0) {
          const errorsDiv = document.getElementById('results-errors');
          errorsDiv.innerHTML = '<h4 style="color: #ff4444; margin-bottom: 10px;">Errors:</h4>';
          data.results.errors.forEach(err => {
            const p = document.createElement('p');
            p.style.color = '#ff6b6b';
            p.textContent = `${err.username}: ${err.error}`;
            errorsDiv.appendChild(p);
          });
        }

        // Add "Next Batch" button
        const nextBatchDiv = document.createElement('div');
        nextBatchDiv.style.marginTop = '20px';
        nextBatchDiv.innerHTML = `
          <button id="next-batch-btn" class="execute-btn" style="background: #5865f2;">
            Load Next Batch
          </button>
        `;
        document.getElementById('results-section').appendChild(nextBatchDiv);

        document.getElementById('next-batch-btn').addEventListener('click', () => {
          // Reload the page to get the next batch
          window.location.reload();
        });

      } catch (error) {
        document.getElementById('progress-section').classList.remove('active');
        document.getElementById('results-section').classList.add('active');
        document.getElementById('results-stats').innerHTML = `
          <div class="error-message">${error.message}</div>
        `;
      }
    });

    function escapeHtml(text) {
      const div = document.createElement('div');
      div.textContent = text;
      return div.innerHTML;
    }
  </script>
</body>
</html>
